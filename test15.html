<!DOCTYPE html>
<html>

<head>
    <style>
        #recommendation {
            border: solid 1px #5faadb;
            background: rgb(229, 249, 252);
            position: absolute;
            left: 0px;
            top: 0px;
            visibility: hidden;
        }

        #controlblock {
            text-align: center;
            /* background-color: rgb(188, 235, 207); */
            width: 100%;
            height: 15vh;
        }

        #inputblock {
            text-align: center;
            /* background-color: rgb(188, 218, 235); */
            width: 100%;
            height: 10vh;
        }

        #previewblock {
            /* background-color: rgb(208, 188, 235); */
            float: right;
            width: 64%;
            height: 70vh;
        }

        #historyblock {
            /* background-color: rgb(235, 188, 194); */
            overflow: scroll;
            float: left;
            width: 34%;
            height: 70vh;
            border-style: solid;
            border-color: rgb(151, 170, 179);
        }

        /* Responsive layout - makes the three columns stack on top of each other instead of next to each other on smaller screens (600px wide or less) */
        @media screen and (max-width: 600px) {

            #previewblock,
            #historyblock {
                width: 100%;
                height: 35vh;
            }
        }

        @media screen {
            #preview {
                width: 100%;
                height: 100%;
            }
        }
    </style>
</head>

<body>
    <div id="start">
        <button onclick="newWindow()">开始投影</button>
        <H1>使用说明</H1>
        <p>
            点击【开始投影】打开投影窗口并进入控制界面。
            将投影窗口拖拽到投影仪对应的显示器，之后所有的操作都可以在控制界面完成。
        </p>
        <p>
            点击输入框进行输入。
            输入的顺序可以是，书名（空格）章（空格）节，或者章（空格）节（空格）书名。
            可以输入下列简写查找书名：
            <pre>
                完整书名的汉语拼音全拼（如yuhanyishu）
                完整书名的汉语拼音首字母（如yhys）
                书名简写的汉语拼音全拼（如yueyi）
                英文书名（如1jhon）
            </pre>
        </p>
        <p>
            当出现联想的时候，
            按【空格键】输入联想的第一个备选项，
            或者按对应【数字键】输入其他备选项。
            只要列表中出现了所需要的书名，
            都可以按【空格键】或者【数字键】输入书名，
            并不需要输入完整的书名或者简写。
        </p>
        <p>
            输入完整后，
            按键盘上【Shift键】或者屏幕上的【预览】可以预览所需要的经节。
            按键盘上【Tab键】可将输入的经节存入历史记录。
            按键盘上【回车键】或者屏幕上的【转到经节】之后投影窗口会转到所需要的经节。
        </p>
        <p>
            点击历史记录按键可以回放之前的经节。
        </p>
        <iframe width="560" height="315" src="https://www.youtube.com/embed/UgE-jYjphCU?cc_load_policy=1"
            frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen></iframe>
    </div>
    <div id="UI" style="display: none;">
        <div id='controlblock'>
            <p id="info"></p>
        </div>

        <div id='inputblock'>
            <input id="input" onkeydown="mainAction()" onkeyup="update()">
            <button onclick="gotoPage(cb,cc,cv)">投影</button>
            <button onclick="previewPage(cb,cc,cv)">预览</button>
            <button onclick="recordPage()">记录</button>
        </div>

        <div id='previewblock'>
            <iframe id="preview" height="300px"></iframe>
        </div>

        <div id='historyblock'>
            <h3>历史记录</h3>
        </div>
        <div id="recommendation">
            <pre id="candidateBookList"></pre>
        </div>
    </div>

    <script src="books.js"></script>
    <script src="textarea-caret-position.js"></script>
    <script src="bible.js"></script>
    <script src="bible_tool.js"></script>
    <script src="project_control.js"></script>

    <script>
        let suggestionKeys = Object.keys(suggestion)
        let linkKeys = Object.keys(link)

        function newWindow() {
            document.getElementById("start").style.display = "none"
            document.getElementById("UI").style.display = "block"
            newPage()
        }

        let candidateBook = []
        let candidateBookDisp = false
        let cb = "", cc = "", cv = ""
        let bcvComplete = false
        init()

        function init() {
            document.getElementById("input").value = ""
            update()
        }

        function update() {
            updateBCV()
            updateList()
            updateInfo()
        }

        function updateBCV() {
            let text = document.getElementById("input").value
            text = text.trim()
            cb = "", cc = "", cv = ""
            bcvComplete = false
            let words = text.split(/[ ,]+/);
            if (words.length > 0) {
                if (!isInt(words[0])) {
                    cb = words[0]
                    if (words.length == 3) {
                        cc = words[1], cv = words[2]
                        if (linkKeys.includes(cb)) {
                            bcvComplete = true
                        }
                    }
                }
                if (words.length == 3) {
                    if (!isInt(words[2])) {
                        cb = words[2], cc = words[0], cv = words[1]
                        if (linkKeys.includes(cb)) {
                            bcvComplete = true
                        }
                    }
                }
            }
        }

        function updateInfo() {
            if (bcvComplete) {
                infoText = '按键盘上[Enter]键投影  ' + cb + cc + "章" + cv + "节  ，按[Shift]键预览，按[Tab]键保存记录"
            } else {
                infoText = '请输入“书名（空格）章（空格）节”，或者“章（空格）节（空格）书名”'
            }
            document.getElementById("info").innerHTML = infoText
        }

        function updateList() {
            // default values
            candidateBookDisp = false
            if (cb == "") {
                candidateBook = []
            } else {
                candidateBook = findBooks(cb)
            }
            // list to displayabel text
            listText = ""
            if (!(linkKeys.includes(cb))) {
                // when the current cb is a fuzzy input
                let n = 5
                if (candidateBook.length < n) {
                    n = candidateBook.length
                }
                for (let i = 0; i < n; i++) {
                    listText += (i + 1).toString() + ": " + candidateBook[i] + "\n"
                    // can display when at leat one item in the text
                    candidateBookDisp = true
                }
            }
            // position and visibility
            let reclist = document.getElementById('recommendation')
            if (candidateBookDisp) {
                document.getElementById("candidateBookList").innerHTML = listText
                let input = document.getElementById('input')
                let caret = getCaretCoordinates(input, input.selectionEnd);
                X = caret.left + input.offsetLeft
                Y = caret.top + input.offsetTop + input.offsetHeight
                reclist.style.visibility = 'visible'
                reclist.style.left = X + 'px'
                reclist.style.top = Y + 'px'
            } else {
                reclist.style.visibility = 'hidden'
            }
        }

        function addRecallButton() {
            let div = document.createElement('div')
            gotoText = "gotoPage('" + cb + "','" + cc + "','" + cv + "')"
            previewText = "previewPage('" + cb + "','" + cc + "','" + cv + "')"
            buttonText = cb + ", " + cc + ", " + cv
            div.innerHTML = '<button onclick="' + gotoText + '") >投影</button>'
            div.innerHTML += '<button onclick="' + previewText + '") >预览</button>'
            div.innerHTML += buttonText
            document.getElementById('historyblock').appendChild(div)
        }

        function mainAction() {
            console.log(event.keyCode)
            let text = document.getElementById("input").value
            // Enter
            if (event.keyCode === 13) {
                event.preventDefault(); // Cancel the default action
                if (bcvComplete) {
                    // redirect side page if infomation complete
                    gotoPage(cb, cc, cv);
                    // create recall button
                    addRecallButton()
                    // clear text
                    init()
                }
            }
            // Tab
            if (event.keyCode === 9) {
                event.preventDefault(); // Cancel the default action
                recordPage()
            }
            // Shift
            if (event.keyCode === 16) {
                event.preventDefault(); // Cancel the default action
                if (bcvComplete) {
                    previewPage(cb, cc, cv);
                }
            }
            // Letter
            if ((event.keyCode >= 65) && (event.keyCode <= 90)) {
                // just input letters
            }
            // number
            if ((event.keyCode >= 49) && (event.keyCode <= 53)) {
                if (candidateBookDisp) {
                    /*
                    if there is a list of candidate books,
                    number keys are used to select books
                    */
                    event.preventDefault();
                    i = event.keyCode - 49
                    if (candidateBook.length >= (i + 1)) {
                        // if input key does not exceed list length
                        document.getElementById("input").value = text.replace(cb, candidateBook[i] + " ")
                    }
                }
                // other wise just input a number digit
            }
            // Space
            if (event.keyCode === 32) {
                /*
                if there is a list of candidate books,
                space will select the first book.
                And a SPACE will be inserted no matter what
                */
                if (candidateBookDisp) {
                    document.getElementById("input").value = text.replace(cb, candidateBook[0])
                }
            }
        }

        function gotoPage(book, chapter, verse) {
            display_verse(book_ind[book], chapter, verse)
        }

        function previewPage(book, chapter, verse) {
            // redirect the preview window to the page of the verse
            if (verse) {
                let domain1 = "https://www.instantbible.org/#/bible/version/cuvs/book/"
                let domain2 = "/chapter/";
                let urlChapter = domain1 + link[book] + domain2 + chapter;
                let urlVerse = urlChapter + '#' + verse;
                console.log(urlChapter)
                console.log(urlVerse)

                let frame = document.getElementById("preview")
                frame.src = urlChapter
                setTimeout(function () { frame.src = urlVerse; }, 1500);
            }
        }

        function recordPage() {
            if (bcvComplete) {
                addRecallButton()
                init()
            }
        }

        function isInt(a) {
            // find if a string is a integer number
            return a == parseInt(a)
        }

        function findBooks(keyWord) {
            // find a list of related books by fuzzy keyWord
            let relatedKeys = fuzzyFinder(keyWord, suggestionKeys);
            let value = []
            for (let i = 0; i < relatedKeys.length; i++) {
                candidateValue = suggestion[relatedKeys[i]];
                if (!(value.includes(candidateValue))) {
                    value.push(candidateValue)
                }
            }
            return value
        }

        function fuzzyFinder(keyWord, list) {
            // fuzzy find keyWord in list
            // this is copied from 
            // https://blog.csdn.net/YeShenLiaoSuiFeng/article/details/80519004
            // need to be improved
            if (!Array.isArray(list) && keyWord !== '') return
            let arr = []
            let reg = new RegExp(keyWord, 'i') // 不区分大小写
            for (let i = 0; i < list.length; i++) {
                if (list[i].match(reg)) arr.push(list[i])
            }
            return arr
        }
    </script>

</body>

</html>